-- Full Pet Spawner UI with Move button dragging (PC + Mobile)
local player = game.Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- GUI Setup
local gui = Instance.new("ScreenGui")
gui.Name = "PetSpawnerUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 350, 0, 270)
frame.Position = UDim2.new(0.5, -175, 0.25, 0)
frame.Active = true
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.ClipsDescendants = false
frame.Parent = gui
Instance.new("UICorner", frame)

-- Top Bar
local top = Instance.new("Frame")
top.Size = UDim2.new(1, 0, 0, 40)
top.Position = UDim2.new(0, 0, 0, 0)
top.Active = true
top.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
top.BorderSizePixel = 0
top.ClipsDescendants = false
top.Parent = frame
Instance.new("UICorner", top)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -140, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "Pet Spawner By Shxdrag"
title.Parent = top

-- Drag bar
local DragBar = Instance.new("Frame")
DragBar.Name = "DragBar"
DragBar.Size = UDim2.new(1, -140, 1, 0)
DragBar.Position = UDim2.new(0, 0, 0, 0)
DragBar.BackgroundTransparency = 1
DragBar.Parent = top

-- Minimize/Expand/Move buttons
local minimize = Instance.new("TextButton")
minimize.Size = UDim2.new(0, 30, 0, 30)
minimize.Position = UDim2.new(1, -120, 0, 5)
minimize.Text = "-"
minimize.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
minimize.TextScaled = true
minimize.Font = Enum.Font.GothamBold
minimize.TextColor3 = Color3.new(1,1,1)
minimize.Parent = top
Instance.new("UICorner", minimize)

local expand = Instance.new("TextButton")
expand.Size = UDim2.new(0, 30, 0, 30)
expand.Position = UDim2.new(1, -120, 0, 5)
expand.Text = "+"
expand.Visible = false
expand.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
expand.TextScaled = true
expand.Font = Enum.Font.GothamBold
expand.TextColor3 = Color3.new(1,1,1)
expand.Parent = top
Instance.new("UICorner", expand)

local moveBtn = Instance.new("TextButton")
moveBtn.Size = UDim2.new(0, 30, 0, 30)
moveBtn.Position = UDim2.new(1, -80, 0, 5)
moveBtn.Text = "â†•"
moveBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
moveBtn.TextScaled = true
moveBtn.Font = Enum.Font.GothamBold
moveBtn.TextColor3 = Color3.new(1,1,1)
moveBtn.Parent = top
Instance.new("UICorner", moveBtn)

-- Drag system
local dragging = false
local dragStart
local startPos
local function updateDrag(input)
	local delta = input.Position - dragStart
	frame.Position = UDim2.new(
		startPos.X.Scale,
		startPos.X.Offset + delta.X,
		startPos.Y.Scale,
		startPos.Y.Offset + delta.Y
	)
end
moveBtn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
		or input.UserInputType == Enum.UserInputType.Touch then

		dragging = true
		dragStart = input.Position
		startPos = frame.Position

		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if dragging then
		if input.UserInputType == Enum.UserInputType.MouseMovement
			or input.UserInputType == Enum.UserInputType.Touch then
			updateDrag(input)
		end
	end
end)

-- Pet Name Box
local petName = Instance.new("TextBox")
petName.Size = UDim2.new(1, -20, 0, 40)
petName.Position = UDim2.new(0, 10, 0, 60)
petName.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
petName.BorderSizePixel = 0
petName.Font = Enum.Font.GothamBold
petName.TextScaled = true
petName.TextColor3 = Color3.fromRGB(255, 255, 255)
petName.PlaceholderText = "Put Pet Name!"
petName.ClearTextOnFocus = false
petName.Parent = frame
Instance.new("UICorner", petName)

-- Rarity Buttons
local rarityFrame = Instance.new("Frame")
rarityFrame.Size = UDim2.new(1, 0, 0, 60)
rarityFrame.Position = UDim2.new(0, 0, 0, 110)
rarityFrame.BackgroundTransparency = 1
rarityFrame.Parent = frame

local uiList = Instance.new("UIListLayout")
uiList.FillDirection = Enum.FillDirection.Horizontal
uiList.HorizontalAlignment = Enum.HorizontalAlignment.Center
uiList.Padding = UDim.new(0, 10)
uiList.Parent = rarityFrame

local selectedRarity = nil
local selectedLabel = Instance.new("TextLabel")
selectedLabel.Size = UDim2.new(1, -20, 0, 30)
selectedLabel.Position = UDim2.new(0, 10, 0, 225)
selectedLabel.BackgroundTransparency = 1
selectedLabel.Font = Enum.Font.GothamSemibold
selectedLabel.TextScaled = true
selectedLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
selectedLabel.Text = "Selected: None"
selectedLabel.Parent = frame

local function createRarityButton(name, color)
	local button = Instance.new("TextButton")
	button.Size = UDim2.new(0, 90, 1, -5)
	button.BackgroundColor3 = color
	button.BorderSizePixel = 0
	button.TextColor3 = Color3.fromRGB(255,255,255)
	button.Font = Enum.Font.GothamBold
	button.TextScaled = true
	button.Text = name
	button.Parent = rarityFrame
	Instance.new("UICorner", button)

	button.MouseButton1Click:Connect(function()
		selectedRarity = name
		selectedLabel.Text = "Selected: " .. name
	end)
end
createRarityButton("MFR", Color3.fromRGB(255, 100, 100))
createRarityButton("NFR", Color3.fromRGB(100, 255, 100))
createRarityButton("FR", Color3.fromRGB(100, 100, 255))

-- Spawn Button
local spawnBtn = Instance.new("TextButton")
spawnBtn.Size = UDim2.new(1, -20, 0, 45)
spawnBtn.Position = UDim2.new(0, 10, 0, 175)
spawnBtn.BackgroundColor3 = Color3.fromRGB(70, 120, 255)
spawnBtn.BorderSizePixel = 0
spawnBtn.Font = Enum.Font.GothamBold
spawnBtn.TextScaled = true
spawnBtn.TextColor3 = Color3.fromRGB(255,255,255)
spawnBtn.Text = "Spawn Pet"
spawnBtn.Parent = frame
Instance.new("UICorner", spawnBtn)

-- Require ClientData
local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
local data = clientData.get_data()[tostring(player)]

-- Make all existing pets rideable/flyable (client-only)
if data and data.inventory and data.inventory.pets then
	for _, pet in pairs(data.inventory.pets) do
		if pet.properties then
			pet.properties.rideable = true
			pet.properties.flyable = true
		end
	end
end

-- ==========================
-- GET BUTTONS FUNCTION
-- ==========================
local function get_buttons(category, pets)
	local buttons = {}
	for _, pet in ipairs(pets) do
		-- Safety checks for expected fields
		if pet.id and pet.uid and pet.template and pet.category and pet.data then
			local btn = {
				id = pet.id,
				uid = pet.uid,
				template = pet.template,
				category = pet.category,
				icon = pet.data.icon or "rbxassetid://0", -- fallback icon
				thumbnail = pet.data.thumbnail or "rbxassetid://0"
			}
			table.insert(buttons, btn)
		else
			warn("[get_buttons] Pet missing required fields:", pet.template or "unknown")
		end
	end
	return buttons
end

-- ==========================
-- RENDER CATEGORY FUNCTION
-- ==========================
local function renderCategory(categoryName)
	-- Grab all pets in this category
	local petsInCategory = {}
	for _, pet in ipairs(data.inventory.pets) do
		if pet.category == categoryName then
			table.insert(petsInCategory, pet)
		end
	end

	-- Build buttons safely
	local buttons = get_buttons(categoryName, petsInCategory)

	-- Example: print buttons for now
	print("[renderCategory] Buttons for", categoryName)
	for _, btn in ipairs(buttons) do
		print("Button:", btn.template, "UID:", btn.uid)
	end

	-- You could replace this print logic with actual GUI rendering if desired
end

-- ==========================
-- TEST BUTTON (Render Pets)
-- ==========================
local renderBtn = Instance.new("TextButton")
renderBtn.Size = UDim2.new(1, -20, 0, 30)
renderBtn.Position = UDim2.new(0, 10, 0, 230)
renderBtn.BackgroundColor3 = Color3.fromRGB(150, 75, 255)
renderBtn.BorderSizePixel = 0
renderBtn.Font = Enum.Font.GothamBold
renderBtn.TextScaled = true
renderBtn.TextColor3 = Color3.fromRGB(255,255,255)
renderBtn.Text = "Render PETS Category"
renderBtn.Parent = frame
Instance.new("UICorner", renderBtn)

renderBtn.MouseButton1Click:Connect(function()
	renderCategory("PETS")
end)


-- SPAWN & AUTO-EQUIP PET
spawnBtn.MouseButton1Click:Connect(function()
	local petTemplate = "Owl" -- testing only Owl

	local newPet = {
		id = HttpService:GenerateGUID(false),
		uid = HttpService:GenerateGUID(false),
		template = petTemplate,
		category = "PETS",        -- THIS MAKES IT SHOW IN BACKPACK
		properties = {
			rideable = true,
			flyable = true,
			neon = false,
			mega = false,
			age = 0,
			level = 1,
			unique = false,
			placeId = 0,
		},
		data = {
			icon = nil,
			thumbnail = nil,
			category = "PETS",      -- Some UI reads nested field
		}
	}


	-- Safe insertion into inventory (numeric table)
	table.insert(data.inventory.pets, newPet)
	print("[PetSpawner] Injected Owl. Total pets now:", #data.inventory.pets)

	-- Auto-equip
	data.equippedPet = newPet
	print("[PetSpawner] Owl auto-equipped!")

	-- Update label
	local rarityTag = selectedRarity or "Legendary"
	selectedLabel.Text = "Pet Spawned & Equipped: "..petTemplate.." ("..rarityTag..")"
	selectedLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
end)

-- Minimize/Expand system
local savedVisibility = {}
local function hideAllContent()
	savedVisibility = {}
	for _, obj in ipairs(frame:GetDescendants()) do
		if obj:IsA("GuiObject") and obj ~= top and not obj:IsDescendantOf(top) then
			savedVisibility[obj] = obj.Visible
			obj.Visible = false
		end
	end
end
local function restoreAllContent()
	for obj, state in pairs(savedVisibility) do
		if obj and obj.Parent then
			obj.Visible = state
		end
	end
	savedVisibility = {}
end

local fullSize = UDim2.new(0, 350, 0, 270)
local minimizedSize = UDim2.new(0, 350, 0, 40)
minimize.MouseButton1Click:Connect(function()
	TweenService:Create(frame, TweenInfo.new(0.3), {Size = minimizedSize}):Play()
	minimize.Visible = false
	expand.Visible = true
	hideAllContent()
end)
expand.MouseButton1Click:Connect(function()
	TweenService:Create(frame, TweenInfo.new(0.3), {Size = fullSize}):Play()
	minimize.Visible = true
	expand.Visible = false
	restoreAllContent()
end)
