--// Pet Spawner LocalScript
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

-- Modules
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Fsys = require(ReplicatedStorage:WaitForChild("Fsys"))
local load = Fsys.load
local clientData = load("ClientData")
local items = load("KindDB")
local router = load("RouterClient")
local downloader = load("DownloadClient")
local animationManager = load("AnimationManager")
local petRigs = load("new:PetRigs")

-- Data tables
local petModels = {}
local pets = {}
local equippedPet = nil
local mountedPet = nil
local currentMountTrack = nil
local selectedRarity = nil

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PetSpawnerGui"
ScreenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 200)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = ScreenGui

-- Top bar for dragging
local topBar = Instance.new("Frame")
topBar.Size = UDim2.new(1, 0, 0, 25)
topBar.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
topBar.Parent = mainFrame

local drag = false
local dragStart
local startPos

topBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        drag = true
        dragStart = input.Position
        startPos = mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                drag = false
            end
        end)
    end
end)

topBar.InputChanged:Connect(function(input)
    if drag and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- Pet Name TextBox
local petName = Instance.new("TextBox")
petName.Size = UDim2.new(0, 200, 0, 25)
petName.Position = UDim2.new(0, 50, 0, 50)
petName.PlaceholderText = "Pet Name"
petName.Text = ""
petName.Parent = mainFrame
petName.BackgroundColor3 = Color3.fromRGB(60,60,60)
petName.TextColor3 = Color3.fromRGB(255,255,255)

-- Rarity buttons
local rarities = {"FR","NFR","MFR"}
local rarityButtons = {}
for i,r in pairs(rarities) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 80, 0, 25)
    btn.Position = UDim2.new(0, 10 + (i-1)*90, 0, 90)
    btn.Text = r
    btn.BackgroundColor3 = Color3.fromRGB(80,80,80)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Parent = mainFrame
    btn.MouseButton1Click:Connect(function()
        selectedRarity = r
        for _,b in pairs(rarityButtons) do
            b.BackgroundColor3 = Color3.fromRGB(80,80,80)
        end
        btn.BackgroundColor3 = Color3.fromRGB(0,150,255)
    end)
    table.insert(rarityButtons, btn)
end

-- Spawn button
local spawnBtn = Instance.new("TextButton")
spawnBtn.Size = UDim2.new(0, 100, 0, 30)
spawnBtn.Position = UDim2.new(0, 100, 0, 150)
spawnBtn.Text = "Spawn Pet"
spawnBtn.BackgroundColor3 = Color3.fromRGB(0,150,255)
spawnBtn.TextColor3 = Color3.fromRGB(255,255,255)
spawnBtn.Parent = mainFrame

-- Backend Functions
local function updateData(key, action)
    local data = clientData.get(key)
    local clonedData = table.clone(data)
    clientData.predict(key, action(clonedData))
end

local function getUniqueId()
    return HttpService:GenerateGUID(false)
end

local function getPetModel(kind)
    if petModels[kind] then return petModels[kind] end
    local streamed = downloader.promise_download_copy("Pets", kind):expect()
    petModels[kind] = streamed
    return streamed
end

local function createPet(id, properties)
    local uniqueId = getUniqueId()
    local pet = nil
    updateData("inventory", function(inventory)
        local newPets = table.clone(inventory.pets)
        local item = items[id]
        pet = {
            unique = uniqueId,
            category = "pets",
            id = id,
            kind = item.kind,
            newness_order = 0,
            properties = properties
        }
        newPets[uniqueId] = pet
        inventory.pets = newPets
        return inventory
    end)
    pets[uniqueId] = {data = pet, model = nil}
    return pet
end

local function neonify(model, entry)
    local petModel = model:FindFirstChild("PetModel")
    if not petModel then return end
    for neonPart, config in pairs(entry.neon_parts or {}) do
        local trueNeonPart = petRigs.get(petModel).get_geo_part(petModel, neonPart)
        trueNeonPart.Material = config.Material
        trueNeonPart.Color = config.Color
    end
end

local function addPetWrapper(wrapper)
    updateData("pet_char_wrappers", function(petWrappers)
        wrapper.unique = #petWrappers + 1
        wrapper.index = #petWrappers + 1
        petWrappers[#petWrappers+1] = wrapper
        return petWrappers
    end)
end

local function addPetState(state)
    updateData("pet_state_managers", function(states)
        states[#states+1] = state
        return states
    end)
end

local function equip(item)
    if equippedPet then
        local pet = pets[equippedPet.unique]
        if pet and pet.model then
            pet.model:Destroy()
            pets[equippedPet.unique].model = nil
        end
    end
    local petModel = getPetModel(item.kind):Clone()
    petModel.Parent = workspace
    pets[item.unique].model = petModel
    if item.properties.neon or item.properties.mega_neon then
        neonify(petModel, items[item.kind])
    end
    equippedPet = item
    addPetWrapper({
        char = petModel,
        mega_neon = item.properties.mega_neon,
        neon = item.properties.neon,
        player = player,
        entity_controller = player,
        controller = player,
        rp_name = item.properties.rp_name or "",
        pet_trick_level = item.properties.pet_trick_level,
        pet_unique = item.unique,
        pet_id = item.id,
        location = {full_destination_id="housing", destination_id="housing", house_owner=player},
        pet_progression = {friendship_level=item.properties.friendship_level, age=item.properties.age, percentage=0},
        are_colors_sealed=false,
        is_pet=true
    })
    addPetState({
        char = petModel,
        player = player,
        store_key = "pet_state_managers",
        is_sitting=false,
        chars_connected_to_me={},
        states={}
    })
end

-- Button click
spawnBtn.MouseButton1Click:Connect(function()
    local nameText = petName.Text
    if nameText == "" then return warn("Enter pet name!") end
    if not selectedRarity then return warn("Select rarity!") end

    local InventoryDB = load("InventoryDB")
    local petId = false
    for _,v in pairs(InventoryDB.pets) do
        if v.name:lower() == nameText:lower() then
            petId = v.id
            break
        end
    end
    if not petId then return warn("Pet not found!") end

    local properties = {}
    if selectedRarity == "NFR" then
        properties.neon = true
    elseif selectedRarity == "MFR" then
        properties.mega_neon = true
    end
    local pet = createPet(petId, properties)
    equip(pet)
    print("[PetSpawner] Spawned pet:", nameText, "Rarity:", selectedRarity)
end)
