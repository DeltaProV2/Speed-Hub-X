-- Full Pet Spawner UI (client-only visual)
local player = game.Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- Require ClientData safely
local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
local data = clientData.get_data()[tostring(player)]

-- === GUI SETUP ===
local gui = Instance.new("ScreenGui")
gui.Name = "PetSpawnerUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 350, 0, 270)
frame.Position = UDim2.new(0.5, -175, 0.25, 0)
frame.Active = true
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.ClipsDescendants = false
frame.Parent = gui
Instance.new("UICorner", frame)

-- Top Bar
local top = Instance.new("Frame")
top.Size = UDim2.new(1, 0, 0, 40)
top.Position = UDim2.new(0, 0, 0, 0)
top.Active = true
top.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
top.BorderSizePixel = 0
top.ClipsDescendants = false
top.Parent = frame
Instance.new("UICorner", top)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -100, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "Pet Spawner By Shxdrag"
title.Parent = top

-- Drag bar
local DragBar = Instance.new("Frame")
DragBar.Size = UDim2.new(1, -100, 1, 0)
DragBar.Position = UDim2.new(0, 0, 0, 0)
DragBar.BackgroundTransparency = 1
DragBar.Parent = top

-- Minimize / Expand / Move Buttons
local function createButton(text, posX)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 30, 0, 30)
    btn.Position = UDim2.new(1, posX, 0, 5)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(80,80,80)
    btn.TextScaled = true
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = top
    Instance.new("UICorner", btn)
    return btn
end

local minimize = createButton("-", -120)
local expand = createButton("+", -120)
expand.Visible = false
local moveBtn = createButton("â†•", -80)

-- === DRAG SYSTEM ===
local dragging = false
local dragStart, startPos
moveBtn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
								   startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- === PET NAME BOX ===
local petName = Instance.new("TextBox")
petName.Size = UDim2.new(1, -20, 0, 40)
petName.Position = UDim2.new(0, 10, 0, 60)
petName.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
petName.BorderSizePixel = 0
petName.Font = Enum.Font.GothamBold
petName.TextScaled = true
petName.TextColor3 = Color3.fromRGB(255,255,255)
petName.PlaceholderText = "Put Pet Name!"
petName.ClearTextOnFocus = false
petName.Parent = frame
Instance.new("UICorner", petName)

-- === SPAWN BUTTON ===
local spawnBtn = Instance.new("TextButton")
spawnBtn.Size = UDim2.new(1, -20, 0, 45)
spawnBtn.Position = UDim2.new(0, 10, 0, 115)
spawnBtn.BackgroundColor3 = Color3.fromRGB(70, 120, 255)
spawnBtn.BorderSizePixel = 0
spawnBtn.Font = Enum.Font.GothamBold
spawnBtn.TextScaled = true
spawnBtn.TextColor3 = Color3.fromRGB(255,255,255)
spawnBtn.Text = "Spawn Pet"
spawnBtn.Parent = frame
Instance.new("UICorner", spawnBtn)

-- Label to show last spawned pet
local selectedLabel = Instance.new("TextLabel")
selectedLabel.Size = UDim2.new(1, -20, 0, 30)
selectedLabel.Position = UDim2.new(0, 10, 0, 170)
selectedLabel.BackgroundTransparency = 1
selectedLabel.Font = Enum.Font.GothamSemibold
selectedLabel.TextScaled = true
selectedLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
selectedLabel.Text = "Last Spawned: None"
selectedLabel.Parent = frame

-- === SPAWN HANDLER ===
spawnBtn.MouseButton1Click:Connect(function()
	local petTemplate = petName.Text
	if not petTemplate or petTemplate == "" then
		warn("[PetSpawner] No pet name entered!")
		return
	end

	-- Ensure Owl template
	if petTemplate:lower() == "owl" then
		petTemplate = "Owl"
	end

	-- Create client-only injected pet
	local newPet = {
		id = "Injected_" .. tostring(os.clock()),
		template = petTemplate,
		properties = {
			rideable = true,
			flyable = true,
			neon = false,
			mega = false,
			age = 0,       -- Newborn
			level = 1,
			unique = false,
			placeId = 0,
		},
		data = {}
	}

	-- Insert into numeric array (Backpack-friendly)
	table.insert(data.inventory.pets, newPet)

	-- Safe Backpack refresh
	local function tryRefreshBackpack()
		local success, uiManager = pcall(function()
			return require(ReplicatedStorage:WaitForChild("ClientModules"):WaitForChild("Core"):WaitForChild("UIManager"))
		end)
		if success and uiManager then
			for _, fnName in ipairs({"refresh_inventory","refresh","update","rebuild"}) do
				if type(uiManager[fnName]) == "function" then
					pcall(uiManager[fnName])
					return
				end
			end
		end
	end
	pcall(tryRefreshBackpack)

	-- Update label
	selectedLabel.Text = "Last Spawned: "..petTemplate
	print("[PetSpawner] Injected pet into client inventory (visual only):", petTemplate)
end)

-- === MINIMIZE / EXPAND ===
local savedVisibility = {}
local fullSize = UDim2.new(0, 350, 0, 270)
local minimizedSize = UDim2.new(0, 350, 0, 40)

local function hideAllContent()
	savedVisibility = {}
	for _, obj in ipairs(frame:GetDescendants()) do
		if obj:IsA("GuiObject") and obj ~= top and not obj:IsDescendantOf(top) then
			savedVisibility[obj] = obj.Visible
			obj.Visible = false
		end
	end
end

local function restoreAllContent()
	for obj, state in pairs(savedVisibility) do
		if obj and obj.Parent then
			obj.Visible = state
		end
	end
	savedVisibility = {}
end

minimize.MouseButton1Click:Connect(function()
	TweenService:Create(frame, TweenInfo.new(0.3), {Size = minimizedSize}):Play()
	minimize.Visible = false
	expand.Visible = true
	hideAllContent()
end)

expand.MouseButton1Click:Connect(function()
	TweenService:Create(frame, TweenInfo.new(0.3), {Size = fullSize}):Play()
	minimize.Visible = true
	expand.Visible = false
	restoreAllContent()
end)
