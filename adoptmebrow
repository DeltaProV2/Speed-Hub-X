-- Full Pet Spawner UI with Move button dragging (PC + Mobile)
print("[PetSpawnerUI] Script started")

local player = game.Players.LocalPlayer
print("[PetSpawnerUI] Player loaded:", player.Name)
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- GUI Setup
local gui = Instance.new("ScreenGui")
gui.Name = "PetSpawnerUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = player:WaitForChild("PlayerGui")
print("[PetSpawnerUI] GUI created and parented")

-- Main Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 350, 0, 270)
frame.Position = UDim2.new(0.5, -175, 0.25, 0)
frame.Active = true
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.ClipsDescendants = false
frame.Parent = gui
Instance.new("UICorner", frame)

-- [Top bar, drag buttons, etc.] ... same as before

-- Require ClientData safely
local clientData
local ok, err = pcall(function()
    clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
end)

if ok then
    print("[PetSpawnerUI] ClientData loaded successfully")
else
    warn("[PetSpawnerUI] Failed to load ClientData:", err)
end

-- Grab player data safely
local data
if clientData then
    local success, d = pcall(function()
        return clientData.get_data()[tostring(player)]
    end)
    if success then
        data = d
        print("[PetSpawnerUI] Player data loaded")
    else
        warn("[PetSpawnerUI] Failed to get player data:", d)
    end
end

-- Make existing pets rideable/flyable (client-only)
if data and data.inventory and data.inventory.pets then
    for _, pet in pairs(data.inventory.pets) do
        if pet.properties then
            pet.properties.rideable = true
            pet.properties.flyable = true
        end
    end
    print("[PetSpawnerUI] Existing pets updated for rideable/flyable")
else
    print("[PetSpawnerUI] No existing pets found or invalid data")
end

-- ==========================
-- GET BUTTONS FUNCTION
-- ==========================
local function get_buttons(category, pets)
    print("[get_buttons] Called for category:", category, "Total pets:", #pets)
    local buttons = {}
    for _, pet in ipairs(pets) do
        if pet.id and pet.uid and pet.template and pet.category and pet.data then
            local btn = {
                id = pet.id,
                uid = pet.uid,
                template = pet.template,
                category = pet.category,
                icon = pet.template,
                thumbnail = pet.template
            }
            table.insert(buttons, btn)
        else
            warn("[get_buttons] Pet missing required fields:", pet.template or "unknown")
        end
    end
    print("[get_buttons] Created buttons:", #buttons)
    return buttons
end

-- ==========================
-- AUTO UPDATE BACKPACK CATEGORY
-- ==========================
local function update_backpack_category(categoryName)
    print("[update_backpack_category] Updating category:", categoryName)
    if not data or not data.inventory or not data.inventory.pets then
        warn("[update_backpack_category] No pets found in inventory")
        return
    end

    local petsInCategory = {}
    for _, pet in ipairs(data.inventory.pets) do
        if pet.category == categoryName then
            table.insert(petsInCategory, pet)
        end
    end

    print("[update_backpack_category] Pets in category:", #petsInCategory)
    local buttons = get_buttons(categoryName, petsInCategory)

    for _, btn in ipairs(buttons) do
        print("[update_backpack_category] Pet:", btn.template, "UID:", btn.uid)
    end
end

-- ==========================
-- SPAWN & AUTO-EQUIP PET
-- ==========================
spawnBtn.MouseButton1Click:Connect(function()
    print("[PetSpawnerUI] Spawn button clicked")
    local petTemplate = petName.Text
    print("[PetSpawnerUI] Pet name entered:", petTemplate)
    if not petTemplate or petTemplate == "" then
        warn("[PetSpawner] No pet name entered!")
        return
    end

    if not data or not data.inventory then
        warn("[PetSpawner] Player data not loaded or invalid")
        return
    end

    local newPet = {
        id = HttpService:GenerateGUID(false),
        uid = HttpService:GenerateGUID(false),
        template = petTemplate,
        category = "PETS",
        properties = {
            rideable = true,
            flyable = true,
            neon = false,
            mega = false,
            age = 0,
            level = 1,
            unique = false,
            placeId = 0,
        },
        data = { category = "PETS" }
    }

    table.insert(data.inventory.pets, newPet)
    print("[PetSpawner] Injected", petTemplate, ". Total pets now:", #data.inventory.pets)

    data.equippedPet = newPet
    print("[PetSpawner] "..petTemplate.." auto-equipped!")

    update_backpack_category("PETS")

    local rarityTag = selectedRarity or "Legendary"
    selectedLabel.Text = "Pet Spawned & Equipped: "..petTemplate.." ("..rarityTag..")"
    selectedLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
end)
